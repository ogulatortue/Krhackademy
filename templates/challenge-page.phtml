<?php
$pageTitle = html_entity_decode($challenge['title']) . ' - Kr[HACK]ademy';
$specific_css = ['/css/content-page.css'];
?>
<!DOCTYPE html>
<html lang="fr">
<?php require __DIR__ . '/partials/head.phtml'; ?>
<body class="page-challenge">
    <a href="/challenges" class="btn-glass back-button"><i class="fas fa-arrow-left"></i> Retour aux challenges</a>
    <main class="content-container">
        <div class="content-wrapper">
            <?php
            $item = $challenge;
            $type = 'challenge';
            require __DIR__ . '/partials/content-page-header.phtml';
            $filename = basename($challenge['challenge_id_str']) . '.html';
            if (strpos($filename, '/') !== false || strpos($filename, '\\') !== false) {
                echo '<section class="content-block"><p>Erreur: Chemin de fichier invalide.</p></section>';
            } else {
                $challengeContentPath = ROOT_PATH . '/public/challenges-content/' . $filename;
                if (file_exists($challengeContentPath)) {
                    include($challengeContentPath);
                } else {
                    echo '<section class="content-block"><p>Le contenu de ce challenge est actuellement indisponible.</p></section>';
                }
            }
            ?>
            <section class="content-block flag-submission">
                <h2><i class="fas fa-flag"></i> Soumettre le Flag</h2>
                <form class="flag-form" id="flag-form">
                    <input type="hidden" name="challenge_id" value="<?= htmlspecialchars($challenge['id']) ?>">
                    <div class="flag-input-wrapper">
                        <span class="flag-prefix">KRK{</span>
                        <input type="text" class="flag-input" name="flag" placeholder="collez_le_flag_ici" required <?= !empty($challenge['is_completed']) ? 'disabled' : '' ?>>
                        <span class="flag-prefix">}</span>
                    </div>
                </form>
                <div class="submission-controls">
                <?php if (!empty($challenge['is_completed'])): ?>
                    <span class="btn-glass validated">Challenge validé <i class="fas fa-check"></i></span>
                    <form class="invalidation-form" style="margin: 0;">
                        <input type="hidden" name="challenge_id" value="<?= htmlspecialchars($challenge['id']) ?>">
                        <button type="submit" class="btn-glass" title="Réinitialiser le challenge"><i class="fas fa-arrow-rotate-left"></i></button>
                    </form>
                <?php else: ?>
                    <button type="submit" form="flag-form" class="btn-glass">Soumettre le flag <i class="fas fa-arrow-right"></i></button>
                <?php endif; ?>
                </div>
            </section>
        </div>
    </main>
    <script src="/js/completion-handler.js" defer></script>
    <script src="/js/copy-btn.js" defer></script>
    <?php require __DIR__ . '/partials/modal.phtml';?>
</body>
</html>