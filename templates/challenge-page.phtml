<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($challenge['title']) ?> - Kr[HACK]ademy</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/content-page.css"/>

    <link rel="icon" type="image/png" href="/images/logo_krhacken_r.ico" />
</head>
<body class="page-challenge">

    <?php
    $points = $challenge['points'];
    $difficulty_class = '';
    if ($points >= 250) { $difficulty_class = 'difficulty-expert'; }
    elseif ($points >= 100) { $difficulty_class = 'difficulty-hard'; }
    elseif ($points >= 50) { $difficulty_class = 'difficulty-medium'; }
    else { $difficulty_class = 'difficulty-easy'; }
    ?>

    <a href="/challenges" class="btn-glass back-button"><i class="fas fa-arrow-left" aria-hidden="true"></i> Retour aux challenges</a>

    <main class="content-container">
        <div class="content-wrapper">
            <header class="content-header">
                <i class="content-icon fas <?= htmlspecialchars($challenge['icon_class'] ?? 'fa-flag') ?>"></i>
                <div class="content-title-group">
                    <h1><?= htmlspecialchars($challenge['title']) ?></h1>
                </div>
                <span class="difficulty-tag <?= $difficulty_class ?>">
                    <?= htmlspecialchars($challenge['points']) ?> pts
                </span>
            </header>
            
            <?php
            $filename = basename($challenge['challenge_id_str']) . '.html';
            $challengeContentPath = ROOT_PATH . '/public/challenges-content/' . $filename;

            if (file_exists($challengeContentPath)) {
                include($challengeContentPath);
            } else {
                echo '<section class="content-block"><p>Le contenu de ce challenge est actuellement indisponible.</p></section>';
            }
            ?>

            <section class="content-block flag-submission">
                <h2><i class="fas fa-flag"></i> Soumettre le Flag</h2>
                <form class="flag-form" id="flag-form" action="/api/verify-flag" method="POST">
                    <input type="hidden" name="challenge_id" value="<?= htmlspecialchars($challenge['id']) ?>">
                    <div class="flag-input-wrapper">
                        <span class="flag-prefix">KRHACK{</span>
                        <input type="text" class="flag-input" name="flag" placeholder="collez_le_hash_ici..." required>
                        <span class="flag-prefix">}</span>
                    </div>
                    <?php
                    $is_completed = !empty($challenge['is_completed']);
                    if ($is_completed) {
                        $button_text = 'Challenge validÃ© <i class="fas fa-check"></i>';
                        $button_class = 'btn-glass validated';
                        $button_disabled = 'disabled';
                    } else {
                        $button_text = 'Soumettre le flag <i class="fas fa-arrow-right"></i>';
                        $button_class = 'btn-glass';
                        $button_disabled = '';
                    }
                    ?>
                    <button type="submit" class="<?= $button_class ?>" <?= $button_disabled ?>>
                        <?= $button_text ?>
                    </button>
                </form>
            </section>
            
        </div>
    </main>
    
    <script src="/js/challenge-page.js" defer></script>

        <?php require __DIR__ . '/partials/modal.phtml';?>
    <script src="/js/modal.js" defer></script>

    <?php
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    $flash_message = null;
    if (isset($_SESSION['flash_message'])) {
        $flash_message = $_SESSION['flash_message'];
        unset($_SESSION['flash_message']);
    }

    if ($flash_message):
    ?>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            modal.showModal(
                '<?= htmlspecialchars($flash_message['type']) ?>',
                '<?= htmlspecialchars($flash_message['title']) ?>',
                '<?= htmlspecialchars($flash_message['message']) ?>'
            );
        });
    </script>
    <?php endif; ?>
</body>
</html>