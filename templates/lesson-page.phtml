<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($lesson['title']) ?> - Kr[HACK]ademy</title>
    
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/content-page.css"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="icon" type="image/png" href="/images/logo_krhacken_r.ico" />
</head>
<body class="page-lesson">

    <a href="/lessons" class="btn-glass back-button"><i class="fas fa-arrow-left" aria-hidden="true"></i> Retour aux leçons</a>

    <?php
    $difficulty_class = '';
    switch (strtolower($lesson['difficulty'])) {
        case 'débutant': $difficulty_class = 'difficulty-easy'; break;
        case 'initié': $difficulty_class = 'difficulty-medium'; break;
        case 'avancé': $difficulty_class = 'difficulty-hard'; break;
        case 'expert': $difficulty_class = 'difficulty-expert'; break;
    }
    ?>

    <main class="content-container">
        <div class="content-wrapper">
            <header class="content-header">
                <i class="content-icon fas <?= htmlspecialchars($lesson['icon_class'] ?? 'fa-book-open') ?>"></i>
                <div class="content-title-group">
                    <h1><?= htmlspecialchars($lesson['title']) ?></h1>
                    <p class="content-intro"><?= htmlspecialchars($lesson['description']) ?></p>
                </div>
                <span class="difficulty-tag <?= $difficulty_class ?>">
                    <?= htmlspecialchars($lesson['difficulty']) ?>
                </span>
            </header>

            <?php
            $filename = basename($lesson['lesson_id_str']) . '.html';
            $lessonContentPath = ROOT_PATH . '/public/lessons-content/' . $filename;

            if (file_exists($lessonContentPath)) {
                include($lessonContentPath);
            } else {
                echo '<section class="content-block"><p>Le contenu de cette leçon est actuellement indisponible.</p></section>';
            }
            ?>
            
            <?php
            $is_completed = !empty($lesson['is_completed']);

            if ($is_completed) {
                $button_text = 'Leçon validée <i class="fas fa-check"></i>';
                $button_class = 'validated';
                $button_disabled_attribute = 'disabled';
            } else {
                $button_text = 'Valider la leçon <i class="fas fa-arrow-right" aria-hidden="true"></i>';
                $button_class = '';
                $button_disabled_attribute = '';
            }
            ?>

            <nav class="content-navigation">
                <form class="completion-form">
                    <input type="hidden" name="lesson_id" value="<?= htmlspecialchars($lesson['id']) ?>">
                    
                    <button type="submit" class="btn-glass <?= $button_class ?>" <?= $button_disabled_attribute ?>>
                        <?= $button_text ?>
                    </button>
                </form>
            </nav>

        </div>
    </main>

    <script src="/js/lesson-page.js" defer></script>

    <?php require __DIR__ . '/partials/modal.phtml';?>
    <script src="/js/modal.js" defer></script>

    <?php
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    $flash_message = null;
    if (isset($_SESSION['flash_message'])) {
        $flash_message = $_SESSION['flash_message'];
        unset($_SESSION['flash_message']);
    }

    if ($flash_message):
    ?>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            modal.showModal(
                '<?= htmlspecialchars($flash_message['type']) ?>',
                '<?= htmlspecialchars($flash_message['title']) ?>',
                '<?= htmlspecialchars($flash_message['message']) ?>'
            );
        });
    </script>
    <?php endif; ?>
</body>
</html>