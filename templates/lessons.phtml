<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Leçons - Kr[HACK]ademy</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/header-footer.css"/>
    <link rel="stylesheet" href="/css/shared-components.css"/>

    <link rel="icon" type="image/png" href="/images/logo_krhacken_r.ico" />
</head>
<body>

    <?php require __DIR__ . '/partials/header.php'; ?>

    <main class="main">
        <?php
        $currentCategory = null; 
        ?>

        <?php foreach ($lessons as $lesson): ?>
            
            <?php 
            if ($lesson['category'] !== $currentCategory): 
                // Si on a déjà une catégorie ouverte, on la ferme d'abord
                if ($currentCategory !== null): ?>
                        </div>
                    </section>
                <?php endif;

                $currentCategory = $lesson['category'];
            ?>
                <section class="category-section">
                    <h2 class="main-title category-title"><?= htmlspecialchars($currentCategory) ?></h2>
                    <div class="box-container">
            <?php endif; ?>
            
            <?php
            // Logique pour la classe de difficulté (inchangée)
            $difficulty_class = '';
            switch (strtolower($lesson['difficulty'])) {
                case 'débutant': $difficulty_class = 'difficulty-easy'; break;
                case 'initié':   $difficulty_class = 'difficulty-medium'; break;
                case 'avancé':   $difficulty_class = 'difficulty-hard'; break;
                case 'expert':   $difficulty_class = 'difficulty-expert'; break;
            }

            // ========================================================================
            // MODIFICATION 1 : Préparer la classe 'completed'
            // On vérifie si la clé 'is_completed' existe et est vraie.
            // Votre contrôleur DOIT fournir cette information dans le tableau $lesson.
            // ========================================================================
            $completed_class = !empty($lesson['is_completed']) ? 'completed' : '';
            ?>

            <a href="/lesson/<?= htmlspecialchars($lesson['id']) ?>" class="card <?= $completed_class ?>" data-lesson-id="<?= htmlspecialchars($lesson['id']) ?>">
                <i class="card-icon fas <?= htmlspecialchars($lesson['icon_class'] ?? 'fa-book-open') ?>"></i>
                <div class="card-text-content">
                    <div class="card-title-wrapper">
                        <h4><?= htmlspecialchars($lesson['title']) ?></h4>
                        <span class="difficulty-tag <?= $difficulty_class ?>">
                            <?= htmlspecialchars($lesson['difficulty']) ?>
                        </span>
                    </div>
                    <p><?= htmlspecialchars($lesson['description']) ?></p>
                </div>
                <div class="check-box">
                    <i class="checkbox-icon completed fas fa-check"></i>
                    <i class="checkbox-icon not-completed far fa-circle"></i>
                </div>
            </a>

        <?php endforeach; ?>

        <?php
        // S'il y avait au moins une leçon, il faut fermer la dernière balise de section
        if (!empty($lessons)): ?>
                </div>
            </section>
        <?php endif; ?>
    </main>

    <?php require __DIR__ . '/partials/footer.php'; ?>
    
    <script src="/js/header.js" defer></script>
    <script src="/js/search.js" defer></script> 
    <script src="/js/progress-tracker.js" defer></script>

</body>
</html>