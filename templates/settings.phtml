<?php
$pageTitle = 'Paramètres - Kr[HACK]ademy';
$specific_css = ['/css/menus.css'];
?>
<!DOCTYPE html>
<html lang="fr">
<?php require __DIR__ . '/partials/head.phtml';?> 
<?php require __DIR__ . '/partials/modal.phtml';?>
<body class="page-settings">
    <a href="<?= $backUrl ?>" class="btn-glass back-button">
        <i class="fas fa-arrow-left"></i> Retour
    </a>
    <main class="container">
        <div class="content-container">
            <div class="content-wrapper menu">
                <header class="content-header">
                    <i class="fas fa-cog content-icon"></i>
                    <div class="content-title-group">
                        <h1>Paramètres</h1>
                        <p class="content-intro">Gérez votre compte, votre sécurité et vos préférences</p>
                    </div>
                </header>

                <?php if (!empty($success)): ?>
                    <div class="alert alert-success"><?php echo $success; ?></div>
                <?php endif; ?>
                <?php if (!empty($errors)): ?>
                    <div class="alert alert-danger">
                        <?php foreach ($errors as $error): ?>
                            <p><?php echo $error; ?></p>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>

                <div class="content-block">
                    <div class="settings-section">
                        <h2>Gestion du Compte</h2>
                        <form action="/settings" method="POST">
                            <input type="hidden" name="csrf_token" value="<?php echo csrf_token(); ?>">
                            <input type="hidden" name="action" value="update_account">
                            <div class="form-group">
                                <label for="username">Pseudo</label>
                                <input type="text" id="username" name="username" class="form-control" value="<?php echo htmlspecialchars($currentUser['username']); ?>">
                            </div>
                            <div class="form-group">
                                <label for="email">Adresse e-mail</label>
                                <input type="email" id="email" name="email" class="form-control" value="<?php echo htmlspecialchars($currentUser['email']); ?>">
                            </div>
                            <div class="form-group">
                                <label for="bio">Bio</label>
                                <textarea id="bio" name="bio" class="form-control" rows="3"><?php echo htmlspecialchars($user['bio'] ?? ''); ?></textarea>
                            </div>
                            <button type="submit" class="btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>

                <div class="content-block">
                    <div class="settings-section">
                        <h2>Sécurité</h2>
                        <form action="/settings" method="POST">
                            <input type="hidden" name="csrf_token" value="<?php echo csrf_token(); ?>">
                            <input type="hidden" name="action" value="change_password">
                            <div class="form-group">
                                <label for="current_password">Mot de passe actuel</label>
                                <input type="password" id="current_password" name="current_password" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="new_password">Nouveau mot de passe</label>
                                <input type="password" id="new_password" name="new_password" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm_password">Confirmer le nouveau mot de passe</label>
                                <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
                            </div>
                            <button type="submit" class="btn-primary">Changer le mot de passe</button>
                        </form>
                    </div>
                </div>

                <div class="content-block" id="custom-profile">
                    <form action="/settings" method="POST">
                    <input type="hidden" name="csrf_token" value="<?php echo csrf_token(); ?>">
                    <div class="settings-section">
                        <h2>Personnalisation du Profil</h2>

                        <!-- AVATAR SELECTION -->
                        <div class="form-group">
                            <label>Choisissez votre avatar</label>
                            <div class="image-selector-grid">
                                <?php foreach ($availableAvatars as $avatarPath): ?>
                                    <?php
                                        $isChecked = ($user['avatar_url'] === $avatarPath);
                                        $isLocked = in_array($avatarPath, $lockedAvatars);
                                    ?>
                                    <div class="selector-item <?= $isLocked ? 'is-locked' : '' ?>">
                                        <input type="radio" 
                                               id="avatar_<?= md5($avatarPath) ?>" 
                                               name="avatar_url" 
                                               value="<?= htmlspecialchars($avatarPath) ?>"
                                               <?= $isChecked ? 'checked' : '' ?>
                                               <?= $isLocked ? 'disabled' : '' ?>>
                                        <label for="avatar_<?= md5($avatarPath) ?>">
                                            <?php if ($isLocked): ?>
                                                <i class="fas fa-lock lock-icon"></i>
                                            <?php endif; ?>
                                            <img src="<?= htmlspecialchars($avatarPath) ?>" alt="Avatar">
                                        </label>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                                            
                        <!-- AVATAR BACKGROUND COLOR SELECTION -->
                        <div class="form-group">
                            <label>Couleur de fond de l'avatar</label>
                            <?php $avatarColors = ['#E6DACC','#2b2b2d','#000000','#8C4040','#57408C','#1D591E','#C3BF60']; ?>
                            <div class="color-selector">
                                 <?php foreach ($avatarColors as $color): ?>
                                    <div class="color-swatch">
                                        <input type="radio" id="avatar_color_<?= str_replace('#','',$color) ?>" name="avatar_bg_color" value="<?= $color ?>" <?= ($user['avatar_bg_color'] ?? '') === $color ? 'checked' : '' ?>>
                                        <label for="avatar_color_<?= str_replace('#','',$color) ?>" style="background-color: <?= $color ?>;"></label>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                                
                        <!-- BANNER SELECTION -->
                        <div class="form-group">
                            <label>Choisissez votre bannière</label>
                            <div class="image-selector-grid banner-grid">
                                <?php foreach ($availableBanners as $bannerPath): ?>
                                    <?php
                                        $isChecked = ($user['banner_url'] === $bannerPath);
                                        $isLocked = in_array($bannerPath, $lockedBanners);
                                    ?>
                                    <div class="selector-item <?= $isLocked ? 'is-locked' : '' ?>">
                                        <input type="radio" 
                                               id="banner_<?= md5($bannerPath) ?>" 
                                               name="banner_url" 
                                               value="<?= htmlspecialchars($bannerPath) ?>"
                                               <?= $isChecked ? 'checked' : '' ?>
                                               <?= $isLocked ? 'disabled' : '' ?>>
                                        <label for="banner_<?= md5($bannerPath) ?>">
                                            <?php if ($isLocked): ?>
                                                <i class="fas fa-lock lock-icon"></i>
                                            <?php endif; ?>
                                            <img src="<?= htmlspecialchars($bannerPath) ?>" alt="Bannière">
                                        </label>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>
                                            
                        <!-- BANNER BACKGROUND COLOR SELECTION -->
                        <div class="form-group">
                            <label>Couleur de fond de la bannière</label>
                             <?php $bannerColors = ['#E6DACC','#2b2b2d','#000000','#8C4040','#57408C','#1D591E','#C3BF60']; ?>
                            <div class="color-selector">
                                <?php foreach ($bannerColors as $color): ?>
                                    <div class="color-swatch">
                                        <input type="radio" id="banner_color_<?= str_replace('#','',$color) ?>" name="banner_bg_color" value="<?= $color ?>" <?= ($user['banner_bg_color'] ?? '') === $color ? 'checked' : '' ?>>
                                        <label for="banner_color_<?= str_replace('#','',$color) ?>" style="background-color: <?= $color ?>;"></label>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" name="update_customization" class="btn-primary">Enregistrer les modifications</button>
                        </div>
                    </div>
                    </form>
                </div>

                <div class="content-block">
                    <div class="settings-section danger-zone">
                        <h2>Zone de Danger</h2>
                        <p>Cette action est irréversible. Toutes vos données seront définitivement supprimées.</p>
                        <form action="/settings" method="POST" onsubmit="return confirm('Êtes-vous absolument certain de vouloir supprimer votre compte ? Cette action est irréversible.');">
                            <input type="hidden" name="csrf_token" value="<?php echo csrf_token(); ?>">
                            <input type="hidden" name="action" value="delete_account">
                            <button type="submit" class="btn-primary btn-danger">Supprimer mon compte</button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </main>
</body>
</html>